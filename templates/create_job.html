<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Create Job</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

    <style>
        #map {
            height: 350px;
            width: 100%;
            border-radius: 0.75rem;
            z-index: 1;
            border: 2px solid #e2e8f0;
        }

        .leaflet-control-geocoder-form input {
            color: black;
            font-size: 12px;
        }

        img.huechange {
            filter: hue-rotate(120deg);
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-xl border border-slate-200 p-8">
        <h2 class="text-2xl font-bold text-slate-800 mb-6">Create New Job</h2>

        <form action="/create_job" method="POST" class="space-y-4">

            <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Client Name</label>
                <input type="text" name="client" placeholder="e.g. Makro KZN" required
                    class="w-full p-3 border border-slate-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
            </div>

            <div>
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-bold text-blue-600">üìç Route Planner</label>
                    <div class="flex gap-2 text-xs">
                        <button type="button" onclick="setMode('pickup')" id="btn-pickup"
                            class="bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700 font-bold transition shadow-sm ring-2 ring-blue-200">Set
                            Pickup</button>
                        <button type="button" onclick="setMode('dropoff')" id="btn-dropoff"
                            class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full hover:bg-emerald-100 hover:text-emerald-700 font-bold transition">Set
                            Dropoff</button>
                    </div>
                </div>
                <div id="map"></div>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Pickup Address</label>
                <input type="text" id="pickup_input" name="pickup" placeholder="Select on map..." required
                    class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50 focus:bg-white transition">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-600 mb-1">Dropoff Address</label>
                <input type="text" id="dropoff_input" name="dropoff" placeholder="Select on map..." required
                    class="w-full p-3 border border-slate-300 rounded-lg bg-slate-50 focus:bg-white transition">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Due Date</label>
                    <input type="datetime-local" id="datePicker" name="date" required
                        class="w-full p-3 border border-slate-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 mb-1">Assign Driver</label>
                    <select name="driver_id" class="w-full p-3 border border-slate-300 rounded-lg bg-white">
                        {% for driver in drivers %}
                        <option value="{{ driver.id }}">{{ driver.username }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="pt-4 flex gap-3">
                <button type="submit"
                    class="flex-1 bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800 transition shadow-lg">Confirm
                    Job</button>
                <a href="/dashboard"
                    class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-lg hover:bg-slate-200 transition text-center">Cancel</a>
            </div>
        </form>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script>
        var map = L.map('map').setView([-29.8587, 31.0218], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

        var activeMode = 'pickup';
        var pickupMarker = null;
        var dropoffMarker = null;
        var routeLine = null;

        var geocoder = L.Control.geocoder({ defaultMarkGeocode: false })
            .on('markgeocode', function (e) { updateLocation(e.geocode.center, e.geocode.name); map.setView(e.geocode.center, 15); })
            .addTo(map);

        map.on('click', function (e) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
                .then(response => response.json())
                .then(data => { updateLocation(e.latlng, data.display_name || "Custom Location"); })
                .catch(error => { updateLocation(e.latlng, "Selected Coordinate"); });
        });

        function updateLocation(latlng, address) {
            if (activeMode === 'pickup') {
                if (pickupMarker) map.removeLayer(pickupMarker);
                pickupMarker = L.marker(latlng).addTo(map).bindPopup("<b>Pickup:</b> " + address).openPopup();
                document.getElementById('pickup_input').value = address;
                setMode('dropoff');
            } else {
                if (dropoffMarker) map.removeLayer(dropoffMarker);
                var greenIcon = new L.Icon.Default(); greenIcon.options.className = 'huechange';
                dropoffMarker = L.marker(latlng).addTo(map).bindPopup("<b>Dropoff:</b> " + address).openPopup();
                dropoffMarker._icon.classList.add('huechange');
                document.getElementById('dropoff_input').value = address;
            }
            if (pickupMarker && dropoffMarker) {
                if (routeLine) map.removeLayer(routeLine);
                routeLine = L.polyline([pickupMarker.getLatLng(), dropoffMarker.getLatLng()], { color: 'blue', dashArray: '10, 10', weight: 3, opacity: 0.6 }).addTo(map);
                map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
            }
        }

        function setMode(mode) {
            activeMode = mode;
            var pBtn = document.getElementById('btn-pickup'); var dBtn = document.getElementById('btn-dropoff');
            if (mode === 'pickup') {
                pBtn.className = "bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700 font-bold transition shadow-sm ring-2 ring-blue-200";
                dBtn.className = "bg-slate-100 text-slate-600 px-3 py-1 rounded-full hover:bg-emerald-100 hover:text-emerald-700 font-bold transition";
            } else {
                pBtn.className = "bg-slate-100 text-slate-600 px-3 py-1 rounded-full hover:bg-blue-100 hover:text-blue-700 font-bold transition";
                dBtn.className = "bg-emerald-600 text-white px-3 py-1 rounded-full hover:bg-emerald-700 font-bold transition shadow-sm ring-2 ring-emerald-200";
            }
        }

        const dateInput = document.getElementById('datePicker');
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        dateInput.min = now.toISOString().slice(0, 16);
    </script>
</body>

</html>